<?xml version="1.0" encoding="utf-8"?>
<root xmlns:android="http://schemas.android.com/apk/res/android">
	<baseBuildGradleAdditions>
		<insert>
			allprojects {
			repositories {
			google()
			mavenCentral()
			}
			}
		</insert>
	</baseBuildGradleAdditions>

	<buildGradleAdditions>
		<insert>
      dependencies {
      implementation 'com.google.ai.edge.litertlm:litertlm-android:0.9.0-alpha01'
      implementation 'org.jetbrains.kotlin:kotlin-stdlib:1.9.20'
      implementation 'org.jetbrains:annotations:24.0.0'
      implementation 'com.google.guava:guava:32.1.3-android'
      }
    </insert>
	</buildGradleAdditions>

	<androidManifestUpdates>
		<addElements tag="application">
			<uses-native-library android:name="libvndksupport.so" android:required="false"/>
			<uses-native-library android:name="libOpenCL.so" android:required="false"/>
		</addElements>
    <addPermission android:name="android.permission.RECORD_AUDIO" />
    <addElements tag="manifest">
      <queries>
        <intent>
          <action android:name="android.intent.action.RECOGNIZE_SPEECH" />
        </intent>
      </queries>
    </addElements>
	</androidManifestUpdates>

	<gameActivityImportAdditions>
		<insert>
      // LiteRTLM Includes
      import com.google.ai.edge.litertlm.Content;
      import com.google.ai.edge.litertlm.Message;

      // STT Includes
      import android.speech.RecognitionListener;
      import android.speech.RecognizerIntent;
      import android.speech.SpeechRecognizer;
      import android.content.Intent;
      import android.os.Bundle;
      import java.util.ArrayList;

    </insert>
	</gameActivityImportAdditions>

	<gameActivityClassAdditions>
		<insert>
      private com.google.ai.edge.litertlm.Engine lmEngine;
      private com.google.ai.edge.litertlm.Conversation lmConversation;
      private com.google.ai.edge.litertlm.Message lmMessage;

      public void AndroidThunkJava_InitWithFunctions(String modelPath) {
      try {
      com.google.ai.edge.litertlm.Backend gpu = com.google.ai.edge.litertlm.Backend.GPU;
      com.google.ai.edge.litertlm.Backend cpu = com.google.ai.edge.litertlm.Backend.CPU;

      com.google.ai.edge.litertlm.EngineConfig config = new com.google.ai.edge.litertlm.EngineConfig(
      modelPath,              // 1. String: Model Path
      cpu,                    // 2. Backend: Base Backend
      null,                    // 3. Backend: Prefill Backend
      null,                    // 4. Backend: Decode Backend
      512,                   // 5. Integer: Max Context Length
      getCacheDir().getPath() // 6. String: Cache Directory Path
      );

      lmEngine = new com.google.ai.edge.litertlm.Engine(config);
      lmEngine.initialize();

      com.google.ai.edge.litertlm.SamplerConfig sampler = new com.google.ai.edge.litertlm.SamplerConfig(40, 0.95, 0.1, 128);

      String systemPrompt = "<![CDATA[" + 
        "You are a model that can do function calling with the following functions" +
        "<start_function_declaration>declaration:move_ai_to_pin{description:<escape>Move the AI NPC to a predefined location.<escape>,parameters:{type:<escape>OBJECT<escape>}}<end_function_declaration>" +
        "<start_function_declaration>declaration:find_nearest_weapon{description:<escape>Find the weapon nearest to the player<escape>,parameters:{type:<escape>OBJECT<escape>}}<end_function_declaration>" +
        "<start_function_declaration>declaration:toggle_tod{description:<escape>Toggle between day and night time of day in the game<escape>,parameters:{type:<escape>OBJECT<escape>}}<end_function_declaration>" +
        "<start_function_declaration>declaration:teleport_player{description:<escape>Teleports the player to a specified location.<escape>,parameters:{properties:{location_tag:{description:<escape>The location tag to teleport to.<escape>,enum:[<escape>red<escape>,<escape>green<escape>,<escape>blue<escape>],type:<escape>STRING<escape>}},required:[<escape>location_tag<escape>],type:<escape>OBJECT<escape>}}<end_function_declaration>" +
        "<start_function_declaration>declaration:find_weapon{description:<escape>Find the weapon defined by the weapon_name parameter.<escape>,parameters:{properties:{weapon_name:{description:<escape>The name of the weapon to find.<escape>,enum:[<escape>pistol<escape>,<escape>rifle<escape>,<escape>grenadelauncher<escape>],type:<escape>STRING<escape>}},required:[<escape>weapon_name<escape>],type:<escape>OBJECT<escape>}}<end_function_declaration>" +
        " <start_function_declaration>declaration:change_weapon_color{description:<escape>Change the color of the weapon held by the player.<escape>,parameters:{properties:{color_name:{description:<escape>The color to change the weapon to.<escape>,enum:[<escape>red<escape>,<escape>green<escape>,<escape>blue<escape>,<escape>white<escape>,<escape>black<escape>,<escape>pink<escape>,<escape>random<escape>],type:<escape>STRING<escape>}},required:[<escape>color_name<escape>],type:<escape>OBJECT<escape>}}<end_function_declaration>" 
        + "]]>";

      com.google.ai.edge.litertlm.ConversationConfig convConfig = new com.google.ai.edge.litertlm.ConversationConfig(
      com.google.ai.edge.litertlm.Message.Companion.of(systemPrompt),
      java.util.Collections.emptyList(),
      sampler);
      lmConversation = lmEngine.createConversation(convConfig);

      android.util.Log.d("LiteRT-LM", "Engine and Conversation Initialized");

      } catch (Exception e) {
      android.util.Log.e("LiteRT-LM", "Initialization failed: " + e.getMessage());
      }
      }

      public String AndroidThunkJava_GenerateResponse(String prompt) {
      if (lmEngine == null || lmConversation == null) {
      return "Error: Engine not initialized";
      }

      try {


      String aiResult = lmConversation.sendMessage(lmMessage.Companion.of(prompt)).toString();

      return aiResult;
      } catch (Exception e) {
      return "Error during generation: " + e.getMessage();
      }
      }


      public void AndroidThunkJava_SubmitFunctionResult(String functionName, String resultJson) {
      String toolMessage = "response:" + functionName + resultJson;
      lmConversation.sendMessage(com.google.ai.edge.litertlm.Message.Companion.of(toolMessage));
      }

      public void AndroidThunkJava_ResetConversation() {
      lmConversation.close();
      com.google.ai.edge.litertlm.SamplerConfig sampler = new com.google.ai.edge.litertlm.SamplerConfig(40, 0.95, 0.1, 128);

      String systemPrompt = "<![CDATA[" + 
        "You are a model that can do function calling with the following functions" +
        "<start_function_declaration>declaration:move_ai_to_pin{description:<escape>Move the AI NPC to a predefined location.<escape>,parameters:{type:<escape>OBJECT<escape>}}<end_function_declaration>" +
        "<start_function_declaration>declaration:find_nearest_weapon{description:<escape>Find the weapon nearest to the player<escape>,parameters:{type:<escape>OBJECT<escape>}}<end_function_declaration>" +
        "<start_function_declaration>declaration:toggle_tod{description:<escape>Toggle between day and night time of day in the game<escape>,parameters:{type:<escape>OBJECT<escape>}}<end_function_declaration>" +
        "<start_function_declaration>declaration:teleport_player{description:<escape>Teleports the player to a specified location.<escape>,parameters:{properties:{location_tag:{description:<escape>The location tag to teleport to.<escape>,enum:[<escape>red<escape>,<escape>green<escape>,<escape>blue<escape>],type:<escape>STRING<escape>}},required:[<escape>location_tag<escape>],type:<escape>OBJECT<escape>}}<end_function_declaration>" +
        "<start_function_declaration>declaration:find_weapon{description:<escape>Find the weapon defined by the weapon_name parameter.<escape>,parameters:{properties:{weapon_name:{description:<escape>The name of the weapon to find.<escape>,enum:[<escape>pistol<escape>,<escape>rifle<escape>,<escape>grenadelauncher<escape>],type:<escape>STRING<escape>}},required:[<escape>weapon_name<escape>],type:<escape>OBJECT<escape>}}<end_function_declaration>" +
        " <start_function_declaration>declaration:change_weapon_color{description:<escape>Change the color of the weapon held by the player.<escape>,parameters:{properties:{color_name:{description:<escape>The color to change the weapon to.<escape>,enum:[<escape>red<escape>,<escape>green<escape>,<escape>blue<escape>,<escape>white<escape>,<escape>black<escape>,<escape>pink<escape>,<escape>random<escape>],type:<escape>STRING<escape>}},required:[<escape>color_name<escape>],type:<escape>OBJECT<escape>}}<end_function_declaration>" 
        + "]]>";

      com.google.ai.edge.litertlm.ConversationConfig convConfig = new com.google.ai.edge.litertlm.ConversationConfig(
      com.google.ai.edge.litertlm.Message.Companion.of(systemPrompt),
      java.util.Collections.emptyList(),
      sampler);
      lmConversation = lmEngine.createConversation(convConfig);
      }

      public void AndroidThunkJava_CloseConnection() {
      if (lmEngine != null || lmConversation != null) {
      lmEngine.close();
      lmConversation.close();
      }

      }


      private String copyAssetToInternal(String fileName) {
      java.io.File file = new java.io.File(getFilesDir(), fileName);
      if (!file.exists()) {
      try (java.io.InputStream is = getAssets().open(fileName);
      java.io.OutputStream os = new java.io.FileOutputStream(file)) {
      byte[] buffer = new byte[1024];
      int length;
      while ((length = is.read(buffer)) > 0) {
      os.write(buffer, 0, length);
      }
      android.util.Log.d("LiteRT-LM", "Model copied to: " + file.getAbsolutePath());
      } catch (java.io.IOException e) {
      android.util.Log.e("LiteRT-LM", "Failed to copy asset: " + e.getMessage());
      return null;
      }
      }
      return file.getAbsolutePath();
      }

      public void AndroidThunkJava_InitWithAssetName(String assetName) {
      String internalPath = copyAssetToInternal(assetName);
      if (internalPath != null) {
      AndroidThunkJava_InitWithFunctions(internalPath);
      }
      }

      public void AndroidThunkJava_ShutdownAll() {
      _activity.runOnUiThread(new Runnable() {
      @Override
      public void run() {

      // 2. Shutdown LiteRT-LM (using your existing CloseConnection logic)
      if (lmEngine != null) {
      lmEngine.close();
      lmEngine = null;
      }
      if (lmConversation != null) {
      lmConversation.close();
      lmConversation = null;
      }

      android.util.Log.d("GemmaVR", "All AI services safely shutdown.");
      }
      });
      }

    </insert>
	</gameActivityClassAdditions>
</root>